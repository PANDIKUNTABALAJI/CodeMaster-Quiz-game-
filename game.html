<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Programming Quiz Game with AI Assistant</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea, #764ba2);
      --secondary-gradient: linear-gradient(135deg, #00c6ff, #0072ff);
      --dark-bg: rgba(0, 0, 0, 0.7);
      --light-bg: rgba(255, 255, 255, 0.95);
      --dark-text: #2d3748;
      --light-text: #f8fafc;
      --highlight: #00c6ff;
      --correct: #4CAF50;
      --wrong: #F44336;
      --basic-level: #4CAF50;
      --intermediate-level: #FFC107;
      --advanced-level: #F44336;
      --shadow: 0 10px 20px rgba(0,0,0,0.2);
      --transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      --chat-primary: #4e54c8;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
      background: var(--primary-gradient);
      color: var(--light-text);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      transition: background 0.5s ease;
      overflow-x: hidden;
      perspective: 1000px;
    }

    body.light-mode {
      background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
      color: var(--dark-text);
    }

    .quiz-container {
      background: var(--dark-bg);
      padding: 30px;
      border-radius: 20px;
      max-width: 800px;
      width: 95%;
      box-shadow: var(--shadow);
      animation: fadeIn 1s ease-in-out;
      transition: var(--transition);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      position: relative;
      overflow: hidden;
      transform-style: preserve-3d;
    }

    .quiz-container::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
      z-index: -1;
      animation: rotate 20s linear infinite;
    }

    .light-mode .quiz-container {
      background: var(--light-bg);
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
      border: 1px solid rgba(0,0,0,0.05);
    }

    /* New Avatar Chatbot Styles */
    /* Collapsed Avatar Icon */
    .avatar-icon {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background-color: #5c6bc0;
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 40px;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      transition: transform 0.3s ease;
      border: 3px solid white;
    }

    .avatar-icon:hover {
      transform: scale(1.1);
    }

    /* Main Chat Container */
    .chat-container {
      width: 90%;
      max-width: 800px;
      height: 85vh;
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transform: scale(0.9);
      transform-origin: bottom right;
      transition: all 0.3s ease;
    }

    .chat-container.active {
      opacity: 1;
      visibility: visible;
      transform: scale(1);
    }

    .avatar-section {
      background-color: #f5f5f5;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      border-bottom: 1px solid #ddd;
      position: relative;
    }

    .close-button {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 24px;
      color: #777;
    }

    .close-button:hover {
      color: #333;
    }

    .avatar-container {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background-color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
      margin-bottom: 15px;
      border: 3px solid #5c6bc0;
      font-size: 70px; /* Size for the emoji */
    }

    .avatar-name {
      font-size: 1.4rem;
      font-weight: bold;
      margin: 0;
      color: #333;
    }

    .avatar-status {
      font-size: 0.9rem;
      color: #4caf50;
      margin-top: 5px;
    }

    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
      background-color: #f9f9f9;
    }

    .message {
      padding: 12px 16px;
      border-radius: 18px;
      max-width: 70%;
      word-wrap: break-word;
    }

    .bot-message {
      background-color: #e3f2fd;
      border: 1px solid #bbdefb;
      align-self: flex-start;
    }

    .user-message {
      background-color: #5c6bc0;
      color: white;
      align-self: flex-end;
    }

    .typing-indicator {
      display: flex;
      padding: 12px 16px;
      background-color: #e3f2fd;
      border: 1px solid #bbdefb;
      border-radius: 18px;
      align-self: flex-start;
      margin-bottom: 10px;
      display: none;
    }

    .typing-indicator span {
      height: 8px;
      width: 8px;
      margin: 0 2px;
      background-color: #5c6bc0;
      display: block;
      border-radius: 50%;
      opacity: 0.4;
    }

    .typing-indicator span:nth-of-type(1) {
      animation: pulse 1s infinite 0.1s;
    }

    .typing-indicator span:nth-of-type(2) {
      animation: pulse 1s infinite 0.2s;
    }

    .typing-indicator span:nth-of-type(3) {
      animation: pulse 1s infinite 0.3s;
    }

    @keyframes pulse {
      0% { opacity: 0.4; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.2); }
      100% { opacity: 0.4; transform: scale(1); }
    }

    .chat-input {
      display: flex;
      padding: 15px;
      background-color: #f5f5f5;
      border-top: 1px solid #ddd;
    }

    #user-input {
      flex: 1;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 20px;
      outline: none;
      font-size: 1rem;
    }

    #send-button {
      background-color: #5c6bc0;
      color: white;
      border: none;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      margin-left: 10px;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: background-color 0.2s;
    }

    #send-button:hover {
      background-color: #3f51b5;
    }

    .avatar-speaking {
      animation: pulse-border 1.5s infinite;
    }

    @keyframes pulse-border {
      0% { border-color: #5c6bc0; }
      50% { border-color: #3f51b5; }
      100% { border-color: #5c6bc0; }
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .chat-container {
        width: 100%;
        height: 100vh;
        max-width: 100%;
        border-radius: 0;
        bottom: 0;
        right: 0;
      }
      
      .avatar-icon {
        bottom: 20px;
        right: 20px;
      }
    }

    /* Quiz game specific styles */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideInLeft {
      from { transform: translateX(-20px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideInRight {
      from { transform: translateX(20px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0px); }
    }

    @keyframes typingAnimation {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    @keyframes bounce {
      0%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-6px); }
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    @keyframes correctAnswer {
      0% { transform: scale(1); }
      50% { transform: scale(1.03); }
      100% { transform: scale(1); }
    }

    @keyframes wrongAnswer {
      0% { transform: translateX(0); }
      20% { transform: translateX(-5px); }
      40% { transform: translateX(5px); }
      60% { transform: translateX(-5px); }
      80% { transform: translateX(5px); }
      100% { transform: translateX(0); }
    }

    @keyframes confetti-fall {
      0% { transform: translateY(-100vh) rotate(0deg); }
      100% { transform: translateY(100vh) rotate(360deg); }
    }

    @keyframes trophySpin {
      0% { transform: rotateY(0deg); }
      100% { transform: rotateY(360deg); }
    }

    @keyframes leaderboardEntry {
      0% { transform: translateY(20px); opacity: 0; }
      100% { transform: translateY(0); opacity: 1; }
    }

    .game-title {
      text-align: center;
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 20px;
      letter-spacing: 1px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
      background: var(--secondary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      position: relative;
      padding-bottom: 10px;
      transform-style: preserve-3d;
    }

    .game-title::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      height: 3px;
      background: var(--highlight);
      border-radius: 3px;
    }

    .light-mode .game-title {
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      background: rgba(0,0,0,0.2);
      padding: 10px 15px;
      border-radius: 10px;
      transform-style: preserve-3d;
    }

    .light-mode .question-header {
      background: rgba(0,0,0,0.05);
    }

    .question-counter {
      font-size: 1.2rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .question-counter i {
      color: var(--highlight);
    }

    .timer {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--highlight);
      display: flex;
      align-items: center;
      gap: 5px;
      animation: pulse 1s infinite;
    }

    .timer.critical {
      animation: pulse 0.5s infinite;
      color: var(--wrong);
    }

    .light-mode .timer {
      color: #0066cc;
    }

    .progress-container {
      width: 100%;
      height: 10px;
      background: rgba(255,255,255,0.2);
      border-radius: 5px;
      margin-bottom: 20px;
      overflow: hidden;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
      transform-style: preserve-3d;
    }

    .light-mode .progress-container {
      background: rgba(0,0,0,0.1);
    }

    .progress-bar {
      height: 100%;
      background: var(--secondary-gradient);
      width: 0%;
      transition: width 0.5s ease;
      border-radius: 5px;
      position: relative;
      overflow: hidden;
    }

    .progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0) 100%);
      animation: shimmer 2s infinite;
    }

    .filters-container {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      transform-style: preserve-3d;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
      transform-style: preserve-3d;
    }

    .filter-label {
      font-size: 0.9rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .filter-select {
      position: relative;
      min-width: 180px;
      transform-style: preserve-3d;
    }

    .filter-select select {
      width: 100%;
      padding: 10px 15px;
      padding-left: 40px;
      border-radius: 10px;
      background: rgba(255,255,255,0.2);
      color: var(--light-text);
      border: none;
      font-family: inherit;
      cursor: pointer;
      appearance: none;
      font-size: 0.9rem;
      transition: var(--transition);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .filter-select::before {
      content: '';
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      z-index: 1;
    }

    .language-select::before {
      background-image: url('https://cdn-icons-png.flaticon.com/512/2881/2881142.png');
    }

    .difficulty-select::before {
      background-image: url('https://cdn-icons-png.flaticon.com/512/2933/2933245.png');
    }

    .light-mode .filter-select select {
      background: rgba(0,0,0,0.05);
      color: var(--dark-text);
    }

    .filter-select select:hover {
      transform: translateY(-2px) rotateX(5deg);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .filter-select select:focus {
      outline: none;
      box-shadow: 0 0 0 2px var(--highlight);
    }

    .question-text {
      font-size: 1.4rem;
      font-weight: 600;
      margin-bottom: 15px;
      line-height: 1.5;
      transform-style: preserve-3d;
    }

    .question-code {
      background: #1e1e2f;
      padding: 15px;
      border-radius: 10px;
      font-family: 'Fira Code', monospace;
      white-space: pre-wrap;
      margin-bottom: 15px;
      color: #00ffea;
      overflow-x: auto;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
      position: relative;
      transform-style: preserve-3d;
    }

    .question-code::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 30px;
      background: rgba(0,0,0,0.2);
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
    }

    .question-code::after {
      content: '•••';
      position: absolute;
      top: 8px;
      left: 15px;
      color: rgba(255,255,255,0.5);
      letter-spacing: 2px;
    }

    .light-mode .question-code {
      background: #f0f0f0;
      color: #0066cc;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
    }

    .options {
      display: flex;
      flex-direction: column;
      gap: 12px;
      transform-style: preserve-3d;
    }

    .option {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 12px;
      cursor: pointer;
      transition: var(--transition);
      border: 2px solid transparent;
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
      overflow: hidden;
      transform-style: preserve-3d;
    }

    .option::before {
      content: attr(data-option);
      font-weight: bold;
      background: rgba(255,255,255,0.2);
      padding: 5px 10px;
      border-radius: 6px;
      min-width: 30px;
      text-align: center;
    }

    .light-mode .option {
      background: rgba(0, 0, 0, 0.05);
    }

    .option:hover {
      background: rgba(0, 198, 255, 0.2);
      border-color: var(--highlight);
      transform: translateX(5px) rotateY(5deg);
    }

    .light-mode .option:hover {
      background: rgba(0, 102, 204, 0.1);
      border-color: #0066cc;
    }

    .option.correct {
      background: rgba(76, 175, 80, 0.3);
      border-color: var(--correct);
      animation: correctAnswer 0.5s ease;
    }

    .option.wrong {
      background: rgba(244, 67, 54, 0.3);
      border-color: var(--wrong);
      animation: wrongAnswer 0.5s ease;
    }

    .controls {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
      transform-style: preserve-3d;
    }

    .btn {
      padding: 12px 25px;
      border-radius: 10px;
      border: none;
      font-family: inherit;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transform-style: preserve-3d;
    }

    .btn:hover {
      transform: translateY(-2px) rotateX(5deg);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .btn-primary {
      background: var(--secondary-gradient);
      color: white;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #00b4f0, #0066cc);
    }

    .light-mode .btn-primary {
      background: var(--secondary-gradient);
      color: white;
    }

    .light-mode .btn-primary:hover {
      background: linear-gradient(135deg, #00b4f0, #0066cc);
    }

    .btn-secondary {
      background: rgba(255,255,255,0.1);
      color: white;
    }

    .light-mode .btn-secondary {
      background: rgba(0,0,0,0.05);
      color: var(--dark-text);
    }

    .btn-logout {
      background: rgba(244, 67, 54, 0.2);
      color: #F44336;
      border: 1px solid #F44336;
    }

    .btn-logout:hover {
      background: rgba(244, 67, 54, 0.3);
    }

    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 50%;
      width: 50px; 
      height: 50px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      transition: var(--transition);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      z-index: 100;
      transform-style: preserve-3d;
    }

    .theme-toggle:hover {
      transform: rotate(30deg) scale(1.1);
    }

    .light-mode .theme-toggle {
      background: rgba(0, 0, 0, 0.1);
    }

    .result {
      text-align: center;
      padding: 20px;
      transform-style: preserve-3d;
    }

    .result-title {
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 20px;
      background: var(--secondary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: fadeIn 0.5s ease;
    }

    .result-score {
      font-size: 5rem;
      margin-bottom: 20px;
      font-weight: 700;
      position: relative;
      display: inline-block;
      animation: fadeIn 0.5s ease;
    }

    .result-score::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      height: 4px;
      background: var(--highlight);
      border-radius: 2px;
    }

    .light-mode .result-score {
      color: #0066cc;
    }

    .result-details {
      margin-bottom: 30px;
      font-size: 1.1rem;
      animation: fadeIn 0.5s ease 0.2s forwards;
      opacity: 0;
    }

    .result-message {
      font-size: 1.2rem;
      margin-bottom: 20px;
      font-style: italic;
      animation: fadeIn 0.5s ease 0.4s forwards;
      opacity: 0;
    }

    .leaderboard {
      margin-top: 30px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      animation: fadeIn 0.5s ease 0.6s forwards;
      opacity: 0;
      transform-style: preserve-3d;
    }

    .light-mode .leaderboard {
      background: rgba(0, 0, 0, 0.05);
    }

    .leaderboard-title {
      text-align: center;
      font-size: 1.5rem;
      margin-bottom: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .leaderboard-title i {
      animation: trophySpin 2s infinite;
    }

    .leaderboard-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .leaderboard-item {
      display: flex;
      justify-content: space-between;
      padding: 12px 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      transition: var(--transition);
      animation: leaderboardEntry 0.5s ease forwards;
      opacity: 0;
      transform-style: preserve-3d;
    }

    .leaderboard-item:nth-child(1) {
      animation-delay: 0.7s;
    }
    .leaderboard-item:nth-child(2) {
      animation-delay: 0.8s;
    }
    .leaderboard-item:nth-child(3) {
      animation-delay: 0.9s;
    }
    .leaderboard-item:nth-child(4) {
      animation-delay: 1.0s;
    }
    .leaderboard-item:nth-child(5) {
      animation-delay: 1.1s;
    }

    .leaderboard-item:hover {
      background: rgba(255,255,255,0.1);
      transform: translateX(5px) rotateY(5deg);
    }

    .leaderboard-item:first-child {
      font-weight: bold;
      color: var(--highlight);
      position: relative;
    }

    .leaderboard-item:first-child::before {
      content: '👑';
      position: absolute;
      left: -25px;
      animation: pulse 2s infinite;
    }

    .light-mode .leaderboard-item {
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .leaderboard-rank {
      font-weight: bold;
      margin-right: 10px;
    }

    .leaderboard-name {
      flex-grow: 1;
    }

    .leaderboard-score {
      font-weight: 600;
    }

    .username-input {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 10px;
      padding: 12px 15px;
      width: 100%;
      margin-bottom: 15px;
      color: var(--light-text);
      font-family: inherit;
      font-size: 1rem;
      transition: var(--transition);
      transform-style: preserve-3d;
    }

    .username-input:focus {
      outline: none;
      box-shadow: 0 0 0 2px var(--highlight);
      transform: translateY(-2px);
    }

    .light-mode .username-input {
      background: rgba(0, 0, 0, 0.05);
      color: var(--dark-text);
    }

    .contact-form {
      background: rgba(255, 255, 255, 0.1);
      padding: 25px;
      border-radius: 15px;
      margin-top: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      transform-style: preserve-3d;
      animation: fadeIn 0.5s ease;
    }

    .light-mode .contact-form {
      background: rgba(0, 0, 0, 0.05);
    }

    .form-title {
      font-size: 1.5rem;
      margin-bottom: 20px;
      text-align: center;
      font-weight: 600;
    }

    .form-group {
      margin-bottom: 20px;
      transform-style: preserve-3d;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .form-input {
      width: 100%;
      padding: 12px 15px;
      border-radius: 10px;
      border: none;
      background: rgba(255, 255, 255, 0.2);
      color: var(--light-text);
      font-family: inherit;
      font-size: 1rem;
      transition: var(--transition);
    }

    .form-input:focus {
      outline: none;
      box-shadow: 0 0 0 2px var(--highlight);
      transform: translateY(-2px);
    }

    .light-mode .form-input {
      background: rgba(0, 0, 0, 0.05);
      color: var(--dark-text);
    }

    .form-textarea {
      height: 120px;
      resize: vertical;
    }

    .hidden {
      display: none;
    }

    #volume-control {
      position: fixed;
      top: 20px;
      left: 20px;
      font-size: 1.5rem;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      z-index: 100;
      transform-style: preserve-3d;
    }

    #volume-control:hover {
      transform: scale(1.1) rotateY(15deg);
    }

    .light-mode #volume-control {
      background: rgba(0, 0, 0, 0.1);
    }

    .language-icon {
      width: 24px;
      height: 24px;
      object-fit: contain;
    }

    .difficulty-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 5px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-left: 5px;
    }

    .difficulty-basic {
      background-color: var(--basic-level);
    }

    .difficulty-intermediate {
      background-color: var(--intermediate-level);
    }

    .difficulty-advanced {
      background-color: var(--advanced-level);
      color: white;
    }

    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background-color: #f00;
      border-radius: 50%;
      animation: confetti-fall 5s linear forwards;
      z-index: 1000;
    }

    .celebration {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 999;
    }

    .footer {
      margin-top: 30px;
      text-align: center;
      font-size: 0.9rem;
      opacity: 0.8;
    }

    /* Hint modal styles */
    .hint-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1001;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .hint-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .hint-content {
      background-color: white;
      padding: 25px;
      border-radius: 10px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      transform-style: preserve-3d;
      animation: fadeIn 0.3s ease;
    }

    .hint-title {
      font-size: 1.5rem;
      margin-bottom: 15px;
      color: var(--chat-primary);
    }

    .close-hint {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #666;
      transition: transform 0.2s;
    }

    .close-hint:hover {
      transform: rotate(90deg);
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .quiz-container {
        padding: 20px;
        width: 95%;
      }
      
      .game-title {
        font-size: 2rem;
      }
      
      .filters-container {
        flex-direction: column;
        gap: 10px;
      }
      
      .filter-select {
        min-width: 100%;
      }
      
      .question-text {
        font-size: 1.2rem;
      }
      
      .result-title {
        font-size: 2rem;
      }
      
      .result-score {
        font-size: 4rem;
      }
    }

    @media (max-width: 480px) {
      .quiz-container {
        padding: 15px;
      }
      
      .game-title {
        font-size: 1.8rem;
      }
      
      .btn {
        padding: 10px 15px;
        font-size: 0.9rem;
      }
      
      .result-title {
        font-size: 1.8rem;
      }
      
      .result-score {
        font-size: 3.5rem;
      }
    }
  </style>
</head>
<body>
  <button id="theme-toggle" class="theme-toggle">☀️</button>
  <button id="volume-control">🔊</button>

  <!-- New Avatar Chatbot -->
  <div class="avatar-icon" id="avatar-icon">🤖</div>
  
  <!-- Main Chat Container -->
  <div class="chat-container" id="chat-container">
    <div class="avatar-section">
      <button class="close-button" id="close-button">×</button>
      <div class="avatar-container" id="avatar-container">
        <div id="avatar-emoji">🤖</div>
      </div>
      <h2 class="avatar-name">AI Quiz Assistant</h2>
      <div class="avatar-status" id="avatar-status">Online</div>
    </div>
    <div class="chat-messages" id="chat-messages">
      <!-- Messages will be added here dynamically -->
    </div>
    <div class="typing-indicator" id="typing-indicator">
      <span></span>
      <span></span>
      <span></span>
    </div>
    <div class="chat-input">
      <input type="text" id="user-input" placeholder="Type your message...">
      <button id="send-button">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      </button>
    </div>
  </div>

  <!-- Hint Modal -->
  <div class="hint-modal" id="hint-modal">
    <div class="hint-content">
      <button class="close-hint" id="close-hint">×</button>
      <h3 class="hint-title">Hint</h3>
      <div id="hint-text">Loading hint...</div>
    </div>
  </div>

  <div class="quiz-container">
    <!-- Start Screen -->
    <div id="start-screen">
      <h1 class="game-title">CodeMaster Quiz Challenge</h1>
      
      <div class="filters-container">
        <div class="filter-group">
          <label for="language-select" class="filter-label">
            <i class="fas fa-code"></i> Language:
          </label>
          <div class="filter-select language-select">
            <select id="language-select">
              <option value="all">All Languages</option>
              <!-- Languages will be populated dynamically -->
            </select>
          </div>
        </div>
        
        <div class="filter-group">
          <label for="difficulty-select" class="filter-label">
            <i class="fas fa-chart-line"></i> Difficulty:
          </label>
          <div class="filter-select difficulty-select">
            <select id="difficulty-select">
              <option value="all">All Levels</option>
              <option value="Basic">Basic</option>
              <option value="Intermediate">Intermediate</option>
              <option value="Advanced">Advanced</option>
            </select>
          </div>
        </div>
      </div>
      
      <button id="start-btn" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
        <i class="fas fa-play"></i> Start Quiz
      </button>
      
      <div class="contact-link" style="margin-top: 30px;">
        <a href="#" id="contact-link" class="btn btn-secondary" style="text-decoration: none;">
          <i class="fas fa-envelope"></i> Contact Us
        </a>
      </div>
    </div>

    <!-- Quiz Screen -->
    <div id="quiz-screen" class="hidden">
      <div class="question-header">
        <div class="question-counter">
          <i class="fas fa-question-circle"></i>
          Question <span id="current">1</span> of <span id="total">10</span>
        </div>
        <div class="timer" id="timer">
          <i class="fas fa-clock"></i> 30
        </div>
      </div>
      
      <div class="progress-container">
        <div class="progress-bar" id="progress-bar"></div>
      </div>
      
      <div class="question-text" id="question"></div>
      <div class="question-code hidden" id="code"></div>
      <div class="options" id="options"></div>
      
      <div class="controls">
        <button id="hint-btn" class="btn btn-secondary">
          <i class="fas fa-lightbulb"></i> Get Hint
        </button>
        <button id="next-btn" class="btn btn-primary hidden">
          <i class="fas fa-arrow-right"></i> Next Question
        </button>
      </div>
    </div>

    <!-- Result Screen -->
    <div id="result-screen" class="hidden">
      <div class="result">
        <div class="result-title">Quiz Complete!</div>
        <div class="result-score" id="score">0/10</div>
        <div class="result-message" id="result-message"></div>
        <div class="result-details" id="result-details">You answered 0 out of 10 questions correctly.</div>
        
        <div id="save-score-form">
          <h3>Save Your Score</h3>
          <input type="text" id="username" class="username-input" placeholder="Enter your name" maxlength="20">
          <button id="save-score-btn" class="btn btn-primary">
            <i class="fas fa-trophy"></i> Save Score
          </button>
        </div>
        
        <div class="controls" style="justify-content: center; gap: 15px;">
          <button id="play-again-btn" class="btn btn-primary">
            <i class="fas fa-redo"></i> Play Again
          </button>
          <button id="logout-btn" class="btn btn-logout">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
        </div>
        
        <div class="leaderboard">
          <h3 class="leaderboard-title">
            <i class="fas fa-crown"></i> Leaderboard
          </h3>
          <ul class="leaderboard-list" id="leaderboard-list">
            <!-- Leaderboard entries will be inserted here -->
          </ul>
        </div>
      </div>
    </div>

    <!-- Contact Form -->
    <div id="contact-form" class="contact-form hidden">
      <h3 class="form-title">
        <i class="fas fa-envelope"></i> Contact Us
      </h3>
      <div class="form-group">
        <label class="form-label" for="contact-name">Name</label>
        <input type="text" id="contact-name" class="form-input" placeholder="Your name">
      </div>
      <div class="form-group">
        <label class="form-label" for="contact-email">Email</label>
        <input type="email" id="contact-email" class="form-input" placeholder="Your email">
      </div>
      <div class="form-group">
        <label class="form-label" for="contact-message">Message</label>
        <textarea id="contact-message" class="form-input form-textarea" placeholder="Your message"></textarea>
      </div>
      <div class="controls">
        <button id="back-btn" class="btn btn-secondary">
          <i class="fas fa-arrow-left"></i> Back
        </button>
        <button id="send-message-btn" class="btn btn-primary">
          <i class="fas fa-paper-plane"></i> Send Message
        </button>
      </div>
    </div>

    <div class="footer hidden" id="footer">
      &copy; 2025 CodeMaster Quiz. All rights reserved.
    </div>
  </div>

  <script>
    // Language icons mapping
    const languageIcons = {
      'javascript': 'fab fa-js-square',
      'python': 'fab fa-python',
      'java': 'fab fa-java',
      'c': 'fas fa-c',
      'c++': 'fas fa-c',
      'c#': 'fas fa-c',
      'php': 'fab fa-php',
      'ruby': 'far fa-gem',
      'go': 'fab fa-golang',
      'rust': 'fas fa-cog',
      'swift': 'fab fa-swift',
      'kotlin': 'fas fa-code',
      'typescript': 'fas fa-code',
      'html': 'fab fa-html5',
      'css': 'fab fa-css3-alt',
      'sql': 'fas fa-database',
      'all': 'fas fa-globe'
    };

    // Audio elements
    const correctSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3');
    const wrongSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3');
    const timerSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3');
    const victorySound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3');
    
    // Configure audio settings
    [correctSound, wrongSound, timerSound, victorySound].forEach(sound => {
      sound.preload = 'auto';
      sound.volume = 0.5;
    });
    
    // Game variables
    let allQuestions = [];
    let questions = [];
    let currentQuestionIndex = 0;
    let score = 0;
    let timer;
    let timeLeft = 30;
    let selectedLanguage = "all";
    let selectedDifficulty = "all";
    let isLightMode = false;
    let isMuted = false;
    
    // DOM Elements
    const startScreen = document.getElementById('start-screen');
    const quizScreen = document.getElementById('quiz-screen');
    const resultScreen = document.getElementById('result-screen');
    const contactForm = document.getElementById('contact-form');
    const languageSelect = document.getElementById('language-select');
    const difficultySelect = document.getElementById('difficulty-select');
    const startBtn = document.getElementById('start-btn');
    const nextBtn = document.getElementById('next-btn');
    const hintBtn = document.getElementById('hint-btn');
    const playAgainBtn = document.getElementById('play-again-btn');
    const saveScoreBtn = document.getElementById('save-score-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const usernameInput = document.getElementById('username');
    const themeToggle = document.getElementById('theme-toggle');
    const volumeControl = document.getElementById('volume-control');
    const timerElement = document.getElementById('timer');
    const progressBar = document.getElementById('progress-bar');
    const contactLink = document.getElementById('contact-link');
    const backBtn = document.getElementById('back-btn');
    const sendMessageBtn = document.getElementById('send-message-btn');
    const footer = document.getElementById('footer');
    const resultMessage = document.getElementById('result-message');
    
    // Chatbot elements
    const avatarIcon = document.getElementById('avatar-icon');
    const chatContainer = document.getElementById('chat-container');
    const closeButton = document.getElementById('close-button');
    const chatMessages = document.getElementById('chat-messages');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const typingIndicator = document.getElementById('typing-indicator');
    const avatarContainer = document.getElementById('avatar-container');
    const avatarStatus = document.getElementById('avatar-status');
    const avatarEmoji = document.getElementById('avatar-emoji');
    const hintModal = document.getElementById('hint-modal');
    const closeHint = document.getElementById('close-hint');
    const hintText = document.getElementById('hint-text');

    // OpenRouter API configuration
    const openRouterConfig = {
      apiUrl: 'https://openrouter.ai/api/v1/chat/completions',
      // Replace with your actual API key
      apiKey: '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',
      referer: window.location.origin,
      siteTitle: 'Avatar Chatbot',
      model: 'microsoft/mai-ds-r1:free', // Using the specific model string you provided
    };

    // Conversation history
    let conversationHistory = [
      { 
        role: "system", 
        content: "You are a friendly AI assistant specialized in programming education. Keep responses helpful and concise. When explaining code or concepts, use clear examples and analogies when helpful." 
      }
    ];

    // Welcome messages
    const welcomeMessages = [
      "👋 Hello! I'm your AI quiz assistant. How can I help you today?",
      "Hi there! 😊 I'm ready to chat about programming concepts. What would you like to know?",
      "Hello! I'm your virtual programming assistant. Feel free to ask me anything about coding!",
      "Greetings! I'm here to help with your programming questions. What can I help with today?"
    ];

    // State tracking
    let hasInitialized = false;

    // Initialize
    function initialize() {
      if (hasInitialized) return;
      
      hasInitialized = true;
      
      // Add welcome message
      const welcomeMessage = welcomeMessages[Math.floor(Math.random() * welcomeMessages.length)];
      setTimeout(() => {
        addBotMessage(welcomeMessage);
      }, 500);
      
      // Load previous conversation if any
      loadConversation();
    }

    // Open chat
    function openChat() {
      chatContainer.classList.add('active');
      avatarIcon.style.display = 'none';
      initialize();
      // Focus on input after opening
      setTimeout(() => {
        userInput.focus();
      }, 300);
    }

    // Close chat
    function closeChat() {
      chatContainer.classList.remove('active');
      avatarIcon.style.display = 'flex';
    }

    // Handle user input
    function handleUserInput() {
      const userMessage = userInput.value.trim();
      if (userMessage === '') return;

      // Add user message to chat
      addUserMessage(userMessage);
      userInput.value = '';

      // Process with AI
      processWithAI(userMessage);
    }

    // Process user message with AI
    async function processWithAI(userMessage) {
      showTypingIndicator();
      avatarStartSpeaking();
      
      // Add user message to conversation history
      conversationHistory.push({
        role: "user",
        content: userMessage
      });

      try {
        const response = await fetch(openRouterConfig.apiUrl, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${openRouterConfig.apiKey}`,
            'HTTP-Referer': openRouterConfig.referer,
            'X-Title': openRouterConfig.siteTitle,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: openRouterConfig.model,
            messages: conversationHistory
          })
        });

        const data = await response.json();
        
        if (data.choices && data.choices[0] && data.choices[0].message) {
          const botResponse = data.choices[0].message.content;
          
          // Add bot response to conversation history
          conversationHistory.push({
            role: "assistant",
            content: botResponse
          });
          
          // Add bot message to chat with typing effect
          hideTypingIndicator();
          
          // Simulate thinking/typing time for natural feel
          const thinkingTime = Math.min(botResponse.length * 20, 2000);
          setTimeout(() => {
            addBotMessage(botResponse);
            avatarStopSpeaking();
            
            // Save conversation
            saveConversation();
          }, thinkingTime);
          
        } else {
          throw new Error('Invalid response from API');
        }
      } catch (error) {
        console.error('Error communicating with OpenRouter API:', error);
        hideTypingIndicator();
        avatarStopSpeaking();
        addBotMessage("Sorry, I'm having trouble connecting right now. Please try again later.");
      }
    }

    // Add a bot message to the chat
    function addBotMessage(message) {
      const messageElement = document.createElement('div');
      messageElement.className = 'message bot-message';
      messageElement.innerHTML = message;
      chatMessages.appendChild(messageElement);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Add a user message to the chat
    function addUserMessage(message) {
      const messageElement = document.createElement('div');
      messageElement.className = 'message user-message';
      messageElement.textContent = message;
      chatMessages.appendChild(messageElement);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Show typing indicator
    function showTypingIndicator() {
      typingIndicator.style.display = 'flex';
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Hide typing indicator
    function hideTypingIndicator() {
      typingIndicator.style.display = 'none';
    }

    // Avatar animation functions
    function avatarStartSpeaking() {
      avatarContainer.classList.add('avatar-speaking');
      avatarStatus.textContent = 'Thinking...';
      avatarStatus.style.color = '#ff9800';
    }

    function avatarStopSpeaking() {
      avatarContainer.classList.remove('avatar-speaking');
      avatarStatus.textContent = 'Online';
      avatarStatus.style.color = '#4caf50';
    }

    // Save conversation to localStorage
    function saveConversation() {
      // Only save if there are user messages (skip just the system prompt)
      if (conversationHistory.length > 1) {
        localStorage.setItem('chatHistory', JSON.stringify(conversationHistory));
      }
    }

    // Load conversation from localStorage
    function loadConversation() {
      const savedChat = localStorage.getItem('chatHistory');
      if (savedChat) {
        const parsedChat = JSON.parse(savedChat);
        // Only load if there are messages to load
        if (parsedChat.length > 1) {
          conversationHistory = parsedChat;
          // Display previous messages (skip system message)
          for (let i = 1; i < conversationHistory.length; i++) {
            const msg = conversationHistory[i];
            if (msg.role === "user") {
              addUserMessage(msg.content);
            } else if (msg.role === "assistant") {
              addBotMessage(msg.content);
            }
          }
        }
      }
    }

    // Clear conversation history
    function clearConversation() {
      conversationHistory = [
        { role: "system", content: "You are a friendly AI assistant. Keep responses helpful and concise." }
      ];
      localStorage.removeItem('chatHistory');
      chatMessages.innerHTML = '';
      addBotMessage("Chat history has been cleared. How can I help you today?");
    }

    // Load questions from external file
    function loadQuestions() {
      fetch('questions.json')
        .then(res => res.json())
        .then(data => {
          allQuestions = processQuestions(data);
          updateLanguageSelector();
          initLeaderboard();
          footer.classList.remove('hidden');
        })
        .catch(error => {
          console.error('Error loading questions:', error);
          allQuestions = generateDynamicQuestions();
          updateLanguageSelector();
          initLeaderboard();
          footer.classList.remove('hidden');
          
          const fallbackMessage = document.createElement('div');
          fallbackMessage.textContent = "Note: Using demo questions. Some features may be limited.";
          fallbackMessage.style.textAlign = "center";
          fallbackMessage.style.padding = "10px";
          fallbackMessage.style.marginTop = "15px";
          fallbackMessage.style.background = "rgba(255,255,255,0.1)";
          fallbackMessage.style.borderRadius = "5px";
          document.querySelector('.quiz-container').appendChild(fallbackMessage);
        });
    }

    // Process questions and assign languages if missing
    function processQuestions(data) {
      return data.map(q => {
        if (!q.language) {
          if (q.question.includes('C code') || q.question.toLowerCase().includes('in c') || 
              (q.code && q.code.includes('#include'))) {
            q.language = 'c';
          } else if (q.question.includes('Python code') || q.question.toLowerCase().includes('in python') ||
                    (q.code && q.code.includes('print('))) {
            q.language = 'python';
          } else if (q.question.includes('JavaScript') || q.question.toLowerCase().includes('in javascript') ||
                    (q.code && (q.code.includes('console.log') || q.code.includes('function')))) {
            q.language = 'javascript';
          } else {
            q.language = 'general';
          }
        }
        
        if (!q.difficulty) {
          q.difficulty = ['Basic', 'Intermediate', 'Advanced'][Math.floor(Math.random() * 3)];
        }
        
        return q;
      });
    }

    // Update language selector with icons
    function updateLanguageSelector() {
      languageSelect.innerHTML = '<option value="all">All Languages</option>';
      
      const languages = [...new Set(allQuestions.map(q => q.language.toLowerCase()))];
      
      languages.forEach(lang => {
        if (lang !== 'general') {
          const option = document.createElement('option');
          option.value = lang.toLowerCase();
          const iconClass = languageIcons[lang] || 'fas fa-code';
          option.textContent = lang.charAt(0).toUpperCase() + lang.slice(1);
          option.dataset.icon = iconClass;
          languageSelect.appendChild(option);
        }
      });
      
      Array.from(languageSelect.options).forEach(option => {
        if (option.value !== 'all') {
          const iconClass = languageIcons[option.value] || 'fas fa-code';
          option.text = `${option.text} (${option.value})`;
        }
      });
    }

    // Play sound with error handling
    function playSound(sound) {
      if (!isMuted && sound) {
        try {
          sound.currentTime = 0;
          sound.play().catch(e => console.log("Audio play failed:", e));
        } catch (e) {
          console.log("Audio error:", e);
        }
      }
    }

    // Initialize leaderboard from localStorage
    function initLeaderboard() {
      if (!localStorage.getItem('quizLeaderboard')) {
        localStorage.setItem('quizLeaderboard', JSON.stringify([]));
      }
      updateLeaderboardDisplay();
    }

    // Update leaderboard display with enhanced styling
    function updateLeaderboardDisplay() {
      const leaderboard = JSON.parse(localStorage.getItem('quizLeaderboard')) || [];
      const leaderboardList = document.getElementById('leaderboard-list');
      
      leaderboardList.innerHTML = '';
      
      leaderboard.sort((a, b) => {
        if (b.score !== a.score) return b.score - a.score;
        return new Date(b.date) - new Date(a.date);
      });
      
      leaderboard.slice(0, 10).forEach((entry, index) => {
        const li = document.createElement('li');
        li.classList.add('leaderboard-item');
        
        const langIcon = languageIcons[entry.language] || 'fas fa-code';
        
        let difficultyBadge = '';
        if (entry.difficulty && entry.difficulty !== 'all') {
          const difficultyClass = `difficulty-${entry.difficulty.toLowerCase()}`;
          difficultyBadge = `<span class="difficulty-badge ${difficultyClass}">${entry.difficulty}</span>`;
        }
        
        li.innerHTML = `
          <div style="display: flex; align-items: center; gap: 10px;">
            <span class="leaderboard-rank">${index + 1}.</span>
            <span class="leaderboard-name">${entry.name}</span>
          </div>
          <div style="display: flex; align-items: center; gap: 10px;">
            <i class="${langIcon}" style="font-size: 1.2rem;"></i>
            <span class="leaderboard-score">${entry.score}/${entry.total}</span>
            ${difficultyBadge}
          </div>
        `;
        leaderboardList.appendChild(li);
      });
      
      if (leaderboard.length === 0) {
        const li = document.createElement('li');
        li.textContent = 'No scores yet. Be the first!';
        li.style.textAlign = 'center';
        li.style.padding = '20px';
        li.style.opacity = '0.7';
        leaderboardList.appendChild(li);
      }
    }

    // Filter questions by selected language and difficulty
    function filterQuestions() {
      let filteredQuestions = [...allQuestions];
      
      if (selectedLanguage !== 'all') {
        filteredQuestions = filteredQuestions.filter(
          q => q.language && q.language.toLowerCase() === selectedLanguage.toLowerCase()
        );
      }
      
      if (selectedDifficulty !== 'all') {
        filteredQuestions = filteredQuestions.filter(
          q => q.difficulty && q.difficulty === selectedDifficulty
        );
      }
      
      if (filteredQuestions.length === 0) {
        return allQuestions.slice(0, 10);
      }
      
      return shuffleArray(filteredQuestions).slice(0, 10);
    }

    // Fisher-Yates shuffle algorithm
    function shuffleArray(array) {
      const newArray = [...array];
      for (let i = newArray.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
      }
      return newArray;
    }

    // Save score to leaderboard with enhanced data
    function saveScore() {
      const name = usernameInput.value.trim();
      if (!name) {
        alert('Please enter your name');
        return;
      }
      
      const leaderboard = JSON.parse(localStorage.getItem('quizLeaderboard')) || [];
      const entry = {
        name,
        score,
        total: questions.length,
        language: selectedLanguage,
        difficulty: selectedDifficulty,
        date: new Date().toISOString(),
        timestamp: Date.now()
      };
      
      leaderboard.push(entry);
      localStorage.setItem('quizLeaderboard', JSON.stringify(leaderboard));
      updateLeaderboardDisplay();
      
      document.getElementById('save-score-form').classList.add('hidden');
      
      const successMsg = document.createElement('div');
      successMsg.textContent = 'Score saved successfully!';
      successMsg.style.textAlign = 'center';
      successMsg.style.margin = '15px 0';
      successMsg.style.color = 'var(--correct)';
      successMsg.style.fontWeight = 'bold';
      document.getElementById('result-screen').insertBefore(
        successMsg, 
        document.querySelector('.controls')
      );
      
      setTimeout(() => {
        successMsg.remove();
      }, 3000);
    }

    // Start the quiz with animations
    function startQuiz() {
      questions = filterQuestions();
      currentQuestionIndex = 0;
      score = 0;
      
      if (questions.length === 0) {
        alert('No questions available with the selected filters. Please try different filters.');
        return;
      }
      
      startScreen.style.animation = 'fadeOut 0.5s ease';
      setTimeout(() => {
        startScreen.classList.add('hidden');
        startScreen.style.animation = '';
        quizScreen.classList.remove('hidden');
        quizScreen.style.animation = 'fadeIn 0.5s ease';
        footer.classList.add('hidden');
      }, 500);
      
      document.getElementById('total').textContent = questions.length;
      showQuestion();
    }

    // Show current question with enhanced UI
    function showQuestion() {
      if (timer) clearInterval(timer);
      
      const questionObj = questions[currentQuestionIndex];
      timeLeft = 30;
      updateTimer();
      startTimer();
      
      document.getElementById('current').textContent = currentQuestionIndex + 1;
      document.getElementById('question').textContent = questionObj.question;
      
      const progressPercent = ((currentQuestionIndex) / questions.length) * 100;
      progressBar.style.width = `${progressPercent}%`;

      const codeBlock = document.getElementById('code');
      if (questionObj.code) {
        codeBlock.textContent = questionObj.code;
        codeBlock.classList.remove('hidden');
        
        if (questionObj.language === 'javascript' || questionObj.language === 'js') {
          codeBlock.innerHTML = highlightJSCode(questionObj.code);
        } else if (questionObj.language === 'python') {
          codeBlock.innerHTML = highlightPythonCode(questionObj.code);
        } else if (questionObj.language === 'c' || questionObj.language === 'c++') {
          codeBlock.innerHTML = highlightCCode(questionObj.code);
        }
      } else {
        codeBlock.classList.add('hidden');
      }

      const optionsDiv = document.getElementById('options');
      optionsDiv.innerHTML = '';
      questionObj.options.forEach((opt, index) => {
        const btn = document.createElement('div');
        btn.classList.add('option');
        btn.textContent = opt;
        btn.dataset.index = index;
        btn.dataset.option = String.fromCharCode(65 + index);
        btn.onclick = () => selectAnswer(index);
        optionsDiv.appendChild(btn);
      });
      
      nextBtn.classList.add('hidden');
    }

    // Simple syntax highlighting functions
    function highlightJSCode(code) {
      const keywords = ['function', 'return', 'const', 'let', 'var', 'if', 'else', 'for', 'while', 'switch', 'case', 'break'];
      return code.replace(
        new RegExp(`\\b(${keywords.join('|')})\\b`, 'g'),
        '<span style="color: #569cd6;">$&</span>'
      ).replace(
        /(".*?"|'.*?'|`.*?`)/g,
        '<span style="color: #ce9178;">$&</span>'
      ).replace(
        /(\/\/.*$)/gm,
        '<span style="color: #6A9955;">$&</span>'
      );
    }

    function highlightPythonCode(code) {
      const keywords = ['def', 'return', 'class', 'if', 'else', 'elif', 'for', 'while', 'try', 'except', 'import', 'from', 'as'];
      return code.replace(
        new RegExp(`\\b(${keywords.join('|')})\\b`, 'g'),
        '<span style="color: #569cd6;">$&</span>'
      ).replace(
        /(".*?"|'.*?')/g,
        '<span style="color: #ce9178;">$&</span>'
      ).replace(
        /(#.*$)/gm,
        '<span style="color: #6A9955;">$&</span>'
      );
    }

    function highlightCCode(code) {
      const keywords = ['include', 'return', 'int', 'char', 'float', 'double', 'void', 'if', 'else', 'for', 'while', 'switch', 'case', 'break', 'struct'];
      return code.replace(
        new RegExp(`\\b(${keywords.join('|')})\\b`, 'g'),
        '<span style="color: #569cd6;">$&</span>'
      ).replace(
        /(".*?"|'.*?')/g,
        '<span style="color: #ce9178;">$&</span>'
      ).replace(
        /(\/\/.*$)/gm,
        '<span style="color: #6A9955;">$&</span>'
      ).replace(
        /(#.*$)/gm,
        '<span style="color: #9CDCFE;">$&</span>'
      );
    }

    // Start timer for current question with visual feedback
    function startTimer() {
      timer = setInterval(() => {
        timeLeft--;
        updateTimer();
        
        if (timeLeft <= 5) {
          playSound(timerSound);
          timerElement.classList.add('critical');
        }
        
        if (timeLeft <= 0) {
          clearInterval(timer);
          handleTimeUp();
        }
      }, 1000);
    }

    // Update timer display with color changes
    function updateTimer() {
      timerElement.innerHTML = `<i class="fas fa-clock"></i> ${timeLeft}`;
      
      if (timeLeft <= 5) {
        timerElement.style.color = '#F44336';
      } else if (timeLeft <= 10) {
        timerElement.style.color = '#FFC107';
      } else {
        timerElement.style.color = '';
        timerElement.classList.remove('critical');
      }
    }

    // Handle when time is up
    function handleTimeUp() {
      const options = document.querySelectorAll('.option');
      const correctIndex = questions[currentQuestionIndex].answer.charCodeAt(0) - 65;
      
      options.forEach((opt, index) => {
        opt.onclick = null;
        if (index === correctIndex) {
          opt.classList.add('correct');
        } else {
          opt.style.opacity = '0.6';
        }
      });
      
      playSound(wrongSound);
      nextBtn.classList.remove('hidden');
    }

    // Select an answer with visual feedback
    function selectAnswer(selectedIndex) {
      clearInterval(timer);
      
      const options = document.querySelectorAll('.option');
      const correctIndex = questions[currentQuestionIndex].answer.charCodeAt(0) - 65;
      
      options.forEach(opt => opt.onclick = null);
      
      if (selectedIndex === correctIndex) {
        options[selectedIndex].classList.add('correct');
        score++;
        playSound(correctSound);
        createConfetti(options[selectedIndex]);
      } else {
        options[selectedIndex].classList.add('wrong');
        options[correctIndex].classList.add('correct');
        playSound(wrongSound);
      }
      
      options.forEach((opt, index) => {
        if (index !== selectedIndex && index !== correctIndex) {
          opt.style.opacity = '0.6';
        }
      });
      
      nextBtn.classList.remove('hidden');
    }

    // Create confetti effect
    function createConfetti(element) {
      const rect = element.getBoundingClientRect();
      const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
      
      for (let i = 0; i < 20; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = `${rect.left + rect.width/2}px`;
        confetti.style.top = `${rect.top}px`;
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.width = `${Math.random() * 8 + 4}px`;
        confetti.style.height = `${Math.random() * 8 + 4}px`;
        confetti.style.animationDuration = `${Math.random() * 3 + 2}s`;
        document.body.appendChild(confetti);
        
        setTimeout(() => {
          confetti.remove();
        }, 5000);
      }
    }

    // Go to next question
    function nextQuestion() {
      currentQuestionIndex++;
      if (currentQuestionIndex < questions.length) {
        showQuestion();
      } else {
        showResult();
      }
    }

    // Show final result with celebration
    function showResult() {
      quizScreen.style.animation = 'fadeOut 0.5s ease';
      setTimeout(() => {
        quizScreen.classList.add('hidden');
        quizScreen.style.animation = '';
        resultScreen.classList.remove('hidden');
        resultScreen.style.animation = 'fadeIn 0.5s ease';
        footer.classList.remove('hidden');
      }, 500);
      
      document.getElementById('score').textContent = `${score}/${questions.length}`;
      document.getElementById('result-details').textContent = 
        `You answered ${score} out of ${questions.length} questions correctly.`;
      
      const percentage = (score / questions.length) * 100;
      let message = '';
      if (percentage >= 90) {
        message = 'Outstanding! You\'re a coding wizard! 🧙‍♂️';
        bigCelebration();
      } else if (percentage >= 70) {
        message = 'Great job! You know your stuff! 👍';
        smallCelebration();
      } else if (percentage >= 50) {
        message = 'Good effort! Keep learning! 📚';
      } else {
        message = 'Keep practicing! You\'ll get better! 💪';
      }
      resultMessage.textContent = message;
      
      updateLeaderboardDisplay();
    }

    // Create big celebration effect for high scores
    function bigCelebration() {
      playSound(victorySound);
      
      const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
      const container = document.createElement('div');
      container.className = 'celebration';
      
      for (let i = 0; i < 100; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = `${Math.random() * 100}vw`;
        confetti.style.top = `-10px`;
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.width = `${Math.random() * 10 + 5}px`;
        confetti.style.height = `${Math.random() * 10 + 5}px`;
        confetti.style.animationDuration = `${Math.random() * 3 + 2}s`;
        confetti.style.animationDelay = `${Math.random() * 2}s`;
        container.appendChild(confetti);
      }
      
      document.body.appendChild(container);
      
      setTimeout(() => {
        container.remove();
      }, 5000);
    }

    // Create small celebration effect
    function smallCelebration() {
      playSound(victorySound);
      
      const container = document.createElement('div');
      container.className = 'celebration';
      
      for (let i = 0; i < 30; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = `${Math.random() * 100}vw`;
        confetti.style.top = `-10px`;
        confetti.style.backgroundColor = '#FFC107';
        confetti.style.width = `${Math.random() * 8 + 4}px`;
        confetti.style.height = `${Math.random() * 8 + 4}px`;
        confetti.style.animationDuration = `${Math.random() * 2 + 1}s`;
        container.appendChild(confetti);
      }
      
      document.body.appendChild(container);
      
      setTimeout(() => {
        container.remove();
      }, 3000);
    }

    // Reset quiz to start again
    function resetQuiz() {
      resultScreen.style.animation = 'fadeOut 0.5s ease';
      setTimeout(() => {
        resultScreen.classList.add('hidden');
        resultScreen.style.animation = '';
        startScreen.classList.remove('hidden');
        startScreen.style.animation = 'fadeIn 0.5s ease';
        document.getElementById('save-score-form').classList.remove('hidden');
        usernameInput.value = '';
      }, 500);
    }

    // Logout and redirect to index.html
    function logout() {
      resultScreen.style.animation = 'fadeOut 0.5s ease';
      setTimeout(() => {
        window.location.href = 'index.html';
      }, 500);
    }

    // Show contact form
    function showContactForm(e) {
      e.preventDefault();
      startScreen.style.animation = 'fadeOut 0.5s ease';
      setTimeout(() => {
        startScreen.classList.add('hidden');
        startScreen.style.animation = '';
        contactForm.classList.remove('hidden');
        contactForm.style.animation = 'fadeIn 0.5s ease';
      }, 500);
    }

    // Hide contact form
    function hideContactForm() {
      contactForm.style.animation = 'fadeOut 0.5s ease';
      setTimeout(() => {
        contactForm.classList.add('hidden');
        contactForm.style.animation = '';
        startScreen.classList.remove('hidden');
        startScreen.style.animation = 'fadeIn 0.5s ease';
      }, 500);
    }

    // Handle contact form submission
    function handleContactSubmit() {
      const name = document.getElementById('contact-name').value.trim();
      const email = document.getElementById('contact-email').value.trim();
      const message = document.getElementById('contact-message').value.trim();
      
      if (!name || !email || !message) {
        alert('Please fill out all fields');
        return;
      }
      
      if (!isValidEmail(email)) {
        alert('Please enter a valid email address');
        return;
      }
      
      // Send email using FormSubmit.co
      const formData = new FormData();
      formData.append('name', name);
      formData.append('email', email);
      formData.append('message', message);
      formData.append('_replyto', email);
      formData.append('_subject', 'New Contact Form Submission from Quiz Game');
      formData.append('_template', 'table');
      
      fetch('https://formsubmit.co/ajax/babukarthik510@gmail.com', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        console.log('Form submitted successfully:', data);
        
        const successMsg = document.createElement('div');
        successMsg.textContent = 'Thank you for your message! We will get back to you soon.';
        successMsg.style.textAlign = 'center';
        successMsg.style.margin = '15px 0';
        successMsg.style.color = 'var(--correct)';
        successMsg.style.fontWeight = 'bold';
        contactForm.insertBefore(successMsg, document.querySelector('.controls'));
        
        document.getElementById('contact-name').value = '';
        document.getElementById('contact-email').value = '';
        document.getElementById('contact-message').value = '';
        
        setTimeout(() => {
          successMsg.remove();
          hideContactForm();
        }, 3000);
      })
      .catch(error => {
        console.error('Error submitting form:', error);
        alert('There was an error submitting your message. Please try again later.');
      });
    }
    
    // Validate email format
    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }
    
    // Toggle theme between light and dark mode
    function toggleTheme() {
      isLightMode = !isLightMode;
      
      if (isLightMode) {
        document.body.classList.add('light-mode');
        themeToggle.innerHTML = '🌙';
      } else {
        document.body.classList.remove('light-mode');
        themeToggle.innerHTML = '☀️';
      }
      
      localStorage.setItem('quizThemePreference', isLightMode ? 'light' : 'dark');
    }
    
    // Toggle sound on/off
    function toggleSound() {
      isMuted = !isMuted;
      
      if (isMuted) {
        volumeControl.innerHTML = '🔇';
      } else {
        volumeControl.innerHTML = '🔊';
      }
      
      localStorage.setItem('quizSoundPreference', isMuted ? 'muted' : 'unmuted');
    }
    
    // Initialize theme based on user preferences
    function initializeTheme() {
      const savedTheme = localStorage.getItem('quizThemePreference');
      
      if (savedTheme === 'light') {
        isLightMode = true;
        document.body.classList.add('light-mode');
        themeToggle.innerHTML = '🌙';
      } else if (savedTheme === 'dark') {
        isLightMode = false;
        document.body.classList.remove('light-mode');
        themeToggle.innerHTML = '☀️';
      } else {
        const prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        if (!prefersDarkMode) {
          isLightMode = true;
          document.body.classList.add('light-mode');
          themeToggle.innerHTML = '🌙';
        }
      }
      
      const savedSound = localStorage.getItem('quizSoundPreference');
      if (savedSound === 'muted') {
        isMuted = true;
        volumeControl.innerHTML = '🔇';
      }
    }

    // Generate dynamic questions for fallback
    function generateDynamicQuestions() {
      const languages = ['JavaScript', 'Python', 'Java', 'C', 'C++', 'C#', 'PHP', 'Ruby', 'Go', 'Rust', 'Swift', 'Kotlin'];
      const difficulties = ['Basic', 'Intermediate', 'Advanced'];
      const questionCount = 50;
      const dynamicQuestions = [];
      
      for (let i = 0; i < questionCount; i++) {
        const language = languages[Math.floor(Math.random() * languages.length)];
        const difficulty = difficulties[Math.floor(Math.random() * difficulties.length)];
        const optionCount = 4;
        const options = [];
        
        for (let j = 0; j < optionCount; j++) {
          options.push(`Sample option ${j+1} for ${language}`);
        }
        
        const question = {
          question: `Sample ${language} question #${i+1} (${difficulty}) - What is the correct answer?`,
          options: options,
          answer: String.fromCharCode(65 + Math.floor(Math.random() * optionCount)),
          language: language.toLowerCase(),
          difficulty: difficulty
        };
        
        if (Math.random() > 0.5) {
          if (language === 'JavaScript') {
            question.code = `// Sample JavaScript code\nfunction example() {\n  return "This is a ${difficulty.toLowerCase()} JavaScript example";\n}`;
          } else if (language === 'Python') {
            question.code = `# Sample Python code\ndef example():\n    return "This is a ${difficulty.toLowerCase()} Python example"`;
          } else if (language === 'C' || language === 'C++') {
            question.code = `// Sample ${language} code\n#include <stdio.h>\n\nint main() {\n    printf("This is a ${difficulty.toLowerCase()} ${language} example\\n");\n    return 0;\n}`;
          } else {
            question.code = `// Sample ${language} code\n// This is a ${difficulty.toLowerCase()} example in ${language}`;
          }
        }
        
        dynamicQuestions.push(question);
      }
      
      return dynamicQuestions;
    }

    // Show hint for current question
    async function showHint() {
      if (!questions[currentQuestionIndex]) return;
      
      hintModal.classList.add('active');
      hintText.textContent = "Thinking of a good hint...";
      
      const question = questions[currentQuestionIndex];
      const prompt = `Provide a helpful hint for this programming quiz question without giving away the answer. 
      The question is about ${question.language} at ${question.difficulty} level.

      Question: ${question.question}
      ${question.code ? 'Code:\n' + question.code : ''}

      The options are:
      ${question.options.map((opt, i) => `${String.fromCharCode(65 + i)}. ${opt}`).join('\n')}

      Provide a concise hint that would help someone reason through to the correct answer.`;
      
      let hint;
      
      if (openRouterConfig.apiKey) {
        try {
          const response = await fetch(openRouterConfig.apiUrl, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${openRouterConfig.apiKey}`,
              'HTTP-Referer': openRouterConfig.referer,
              'X-Title': openRouterConfig.siteTitle,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              model: openRouterConfig.model,
              messages: [
                {
                  role: "system",
                  content: "You are a helpful AI assistant specialized in programming education. Provide concise hints for quiz questions without giving away the answer directly."
                },
                {
                  role: "user",
                  content: prompt
                }
              ]
            })
          });

          const data = await response.json();
          hint = data.choices?.[0]?.message?.content || "Couldn't generate a hint. Please try again.";
        } catch (error) {
          console.error('Error getting hint:', error);
          hint = "Sorry, I couldn't generate a hint right now. Please try again later.";
        }
      } else {
        hint = "To get hints, please configure your OpenRouter API key in the chatbot settings.";
      }
      
      hintText.textContent = hint;
    }

    // Initialize app when DOM is loaded
    window.addEventListener('DOMContentLoaded', () => {
      // Initialize theme and sound preferences
      initializeTheme();
      
      // Load questions and initialize leaderboard
      loadQuestions();
      
      // Initialize chatbot
      loadConversation();
      
      // Add welcome message after a short delay
      setTimeout(() => {
        if (conversationHistory.length <= 1) {
          const welcomeMessage = welcomeMessages[Math.floor(Math.random() * welcomeMessages.length)];
          addBotMessage(welcomeMessage);
        }
      }, 1000);
      
      // Event listeners for chatbot
      avatarIcon.addEventListener('click', openChat);
      closeButton.addEventListener('click', closeChat);
      sendButton.addEventListener('click', handleUserInput);
      userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleUserInput();
      });
      
      // Event listeners for quiz game
      startBtn.addEventListener('click', startQuiz);
      nextBtn.addEventListener('click', nextQuestion);
      hintBtn.addEventListener('click', showHint);
      playAgainBtn.addEventListener('click', resetQuiz);
      saveScoreBtn.addEventListener('click', saveScore);
      logoutBtn.addEventListener('click', logout);
      themeToggle.addEventListener('click', toggleTheme);
      volumeControl.addEventListener('click', toggleSound);
      contactLink.addEventListener('click', showContactForm);
      backBtn.addEventListener('click', hideContactForm);
      sendMessageBtn.addEventListener('click', handleContactSubmit);
      closeHint.addEventListener('click', () => hintModal.classList.remove('active'));
      
      // Language and difficulty selectors
      languageSelect.addEventListener('change', (e) => {
        selectedLanguage = e.target.value;
      });
      
      difficultySelect.addEventListener('change', (e) => {
        selectedDifficulty = e.target.value;
      });
    });
  </script>
</body>
</html>
